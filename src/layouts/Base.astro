---
import TwSizeIndicator from "@/components/TwSizeIndicator.astro";
import config from "@/config/config.json";
import theme from "@/config/theme.json";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import FloatingBubble from "@/components/FloatingBubble.jsx";
import "@/styles/main.css";
import { AstroFont } from "astro-font";
import { ClientRouter } from "astro:transitions";
import SEO from "@/layouts/components/SEO.astro";

const pf = theme.fonts.font_family.primary;
let fontPrimary;
if (theme.fonts.font_family.primary) {
  fontPrimary = theme.fonts.font_family.primary
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;]+/gi, "");
}

export interface Props {
  title?: string;
  meta_title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  canonical?: string;
}

const { title, meta_title, description, image, noindex, canonical } = Astro.props;

// === IMPROVED: HTML escape function that handles already-encoded entities ===
const escapeHtml = (text) => {
  if (!text) return '';
  
  // First, decode any existing HTML entities to avoid double-encoding
  let processed = text.toString()
    .replace(/&amp;/g, '&')   // Decode &amp; to &
    .replace(/&lt;/g, '<')    // Decode &lt; to <
    .replace(/&gt;/g, '>')    // Decode &gt; to >
    .replace(/&quot;/g, '"')  // Decode &quot; to "
    .replace(/&#039;/g, "'")  // Decode &#039; to '
    .replace(/&nbsp;/g, ' '); // Decode &nbsp; to space
  
  // Then properly encode everything for HTML attributes
  return processed
    .replace(/&/g, '&amp;')   // Encode & to &amp;
    .replace(/</g, '&lt;')    // Encode < to &lt;
    .replace(/>/g, '&gt;')    // Encode > to &gt;
    .replace(/"/g, '&quot;')  // Encode " to &quot;
    .replace(/'/g, '&#039;')  // Encode ' to &#039;
    .trim();
};

// Use escapeHtml for meta tags
const finalTitle = escapeHtml(meta_title ?? title ?? config.site.title);
const finalDescription = escapeHtml(description ?? config.metadata.meta_description);

// Handle image prop safely
const finalImage = image && typeof image === 'string' && image.trim()
  ? `${config.site.base_url}${image.startsWith("/") ? "" : "/"}${image}`
  : `${config.site.base_url}${config.metadata.meta_image}`;

// FIXED: Normalize canonical URL - remove trailing slash and query parameters
const cleanPath = Astro.url.pathname.replace(/\/$/, ""); // Remove trailing slash
const finalCanonical = canonical ?? `${config.site.base_url}${cleanPath}`;
---
<!doctype html>
<html lang="en">
  <head>
    {/* GOOGLE ANALYTICS GA4 - LIVE */}
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W77T47Y58P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W77T47Y58P');
    </script>

    {/* Ahrefs Web Analytics */}
    <script src="https://analytics.ahrefs.com/analytics.js" data-key="BM9NrhHESqRca7xP0Vuqeg" async></script>

    {/* Google Search Console verification placeholder */}
    {/* <meta name="google-site-verification" content="your-code-here" /> */}

    <link rel="shortcut icon" href={config.site.favicon} />
    <meta name="theme-name" content="bookworm-light-astro" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000" />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary!,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
      ]}
    />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

    <!-- ========== USE SEO COMPONENT INSTEAD OF DUPLICATE TAGS ========== -->
    <SEO
      title={finalTitle}
      description={finalDescription}
      image={finalImage}
      canonical={finalCanonical}
      noindex={!!noindex}
      type="website"
    />
    <!-- ========== END SEO COMPONENT ========== -->

    <link rel="alternate" type="application/rss+xml" title="Txchyon RSS" href="/rss.xml" />
    <link rel="alternate" type="application/feed+json" title="Txchyon JSON Feed" href="/feed.json" />

    <ClientRouter />
    <meta name="author" content={config.metadata.meta_author} />
    
    <!-- Critical theme CSS -->
    <style>
      /* Initialize with dark mode by default to prevent flash */
      :root {
        color-scheme: light dark;
      }
      
      /* Smooth transitions */
      * {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      }
    </style>
  </head>

  <body class="bg-body text-text font-primary font-normal leading-relaxed dark:bg-dark dark:text-light">
    <TwSizeIndicator />
    <Header />
    <main id="main-content" class="min-h-[60vh]">
      <slot />
    </main>
    <Footer />

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <FloatingBubble client:load />
  
    <!-- FIXED THEME PERSISTENCE SCRIPT -->
    <script is:global>
      // ============================================
      // FIXED: Theme Persistence Script
      // ============================================
      
      // Initialize theme immediately (no FOUC)
      (function() {
        const THEME_KEY = 'txchyon-theme';
        const html = document.documentElement;
        
        // Function to get saved theme
        function getSavedTheme() {
          try {
            const saved = localStorage.getItem(THEME_KEY);
            if (saved === 'dark' || saved === 'light') {
              return saved;
            }
          } catch (e) {
            // localStorage not available
          }
          
          // Check system preference
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          return prefersDark ? 'dark' : 'light';
        }
        
        // Function to apply theme
        function applyTheme(theme) {
          if (theme === 'dark') {
            html.classList.add('dark');
          } else {
            html.classList.remove('dark');
          }
          html.setAttribute('data-theme', theme);
          
          // Update meta theme-color
          const metaThemeColor = document.querySelector('meta[name="theme-color"]');
          if (metaThemeColor) {
            metaThemeColor.setAttribute('content', theme === 'dark' ? '#000000' : '#ffffff');
          }
        }
        
        // Function to save theme
        function saveTheme(theme) {
          try {
            localStorage.setItem(THEME_KEY, theme);
          } catch (e) {
            // localStorage not available
          }
        }
        
        // Initialize theme on page load
        const savedTheme = getSavedTheme();
        applyTheme(savedTheme);
        saveTheme(savedTheme); // Save if not already saved
        
        // Global toggle function
        window.toggleDarkMode = function() {
          const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          applyTheme(newTheme);
          saveTheme(newTheme);
          
          // Dispatch custom event for any listeners
          window.dispatchEvent(new CustomEvent('themechange', { 
            detail: { theme: newTheme } 
          }));
        };
        
        // Listen for system preference changes (only if user hasn't made a choice)
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', (e) => {
          const saved = localStorage.getItem(THEME_KEY);
          if (!saved) {
            const newTheme = e.matches ? 'dark' : 'light';
            applyTheme(newTheme);
            saveTheme(newTheme);
          }
        });
        
        // Mark theme as initialized
        html.classList.add('theme-initialized');
      })();
      
      // ============================================
      // Attach click handlers
      // ============================================
      document.addEventListener('DOMContentLoaded', () => {
        // Attach click handler to theme toggle button
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          // Remove any existing listeners
          const newToggleBtn = toggleBtn.cloneNode(true);
          toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
          
          // Add click listener
          document.getElementById('theme-toggle').addEventListener('click', window.toggleDarkMode);
        }
        
        // Update theme toggle icon
        function updateThemeIcon() {
          const icon = document.getElementById('theme-icon');
          if (icon) {
            const isDark = document.documentElement.classList.contains('dark');
            icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
          }
        }
        
        // Update icon on load
        updateThemeIcon();
        
        // Update icon on theme change
        window.addEventListener('themechange', updateThemeIcon);
      });
      
      // Re-attach listener on page navigation (for Astro View Transitions)
      document.addEventListener('astro:page-load', () => {
        // Re-attach theme toggle button listener
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', window.toggleDarkMode);
        }
        
        // Update theme icon
        const icon = document.getElementById('theme-icon');
        if (icon) {
          const isDark = document.documentElement.classList.contains('dark');
          icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        }
      });
    </script>
  </body>
</html>