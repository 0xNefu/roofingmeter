---
import TwSizeIndicator from "@/components/TwSizeIndicator.astro";
import config from "@/config/config.json";
import theme from "@/config/theme.json";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import FloatingBubble from "@/components/FloatingBubble.jsx";
import "@/styles/main.css";
import { AstroFont } from "astro-font";
import { ClientRouter } from "astro:transitions";
import SEO from "@/layouts/components/SEO.astro";

const currentPath = Astro.url.pathname;

// Get frontmatter props
const { 
  title, 
  meta_title, 
  description, 
  image, 
  noindex, 
  canonical,
  hasGatedContent = false,
  gateType = 'partial'
} = Astro.props;

console.log('üè† RoofingMeter Layout:', {
  path: currentPath,
  hasGatedContent,
  gateType
});

const pf = theme.fonts.font_family.primary;
let fontPrimary;
if (theme.fonts.font_family.primary) {
  fontPrimary = theme.fonts.font_family.primary
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;]+/gi, "");
}

export interface Props {
  title?: string;
  meta_title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  canonical?: string;
  hasGatedContent?: boolean;
  gateType?: 'partial' | 'full';
}

const finalTitle = meta_title ?? title ?? config.site.title;
const finalDescription = description ?? config.metadata.meta_description;

const finalImage = image && typeof image === 'string' && image.trim()
  ? `${config.site.base_url}${image.startsWith("/") ? "" : "/"}${image}`
  : `${config.site.base_url}${config.metadata.meta_image}`;

const cleanPath = Astro.url.pathname.replace(/\/$/, "");
const finalCanonical = canonical ?? `${config.site.base_url}${cleanPath}`;
---
<!doctype html>
<html lang="en">
  <head>
    <!-- RoofingMeter Google Analytics -->
    <!-- Create and add your RoofingMeter-specific GA4 tag here -->
    <!-- 
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ROOFINGMETER"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ROOFINGMETER');
    </script>
    -->

    <!-- RoofingMeter Google AdSense (Income Generation) -->
    <!-- Apply for AdSense separately for roofingmeter.com -->
    <!-- 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-ROOFINGMETER-PUBLISHER-ID" crossorigin="anonymous"></script>
    -->

    <!-- RoofingMeter Ahrefs Analytics -->
    <!-- Get separate Ahrefs account for roofingmeter.com -->
    <!-- 
    <script src="https://analytics.ahrefs.com/analytics.js" data-key="ROOFINGMETER-AHREFS-KEY" async></script>
    -->

    <link rel="shortcut icon" href={config.site.favicon} />
    <meta name="theme-name" content="roofingmeter-astro" />
    <meta name="msapplication-TileColor" content="#1e3a8a" />
    <meta name="theme-color" content="#1e3a8a" />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary!,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
      ]}
    />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

    <SEO
      title={finalTitle}
      description={finalDescription}
      image={finalImage}
      canonical={finalCanonical}
      noindex={!!noindex}
      type="website"
    />

    <!-- SCHEMA MARKUP FOR ROOFING BUSINESS -->
    {title && (
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "name": "RoofingMeter",
          "url": "{config.site.base_url}",
          "description": "{config.metadata.meta_description}",
          "publisher": {
            "@type": "Organization",
            "name": "RoofingMeter",
            "url": "{config.site.base_url}",
            "parentOrganization": {
              "@type": "Organization",
              "name": "Txchyon Capital",
              "url": "https://txchyon.com"
            }
          },
          "potentialAction": {
            "@type": "SearchAction",
            "target": "{config.site.base_url}/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
          }
        }
      </script>
    )}

    <link rel="alternate" type="application/rss+xml" title="RoofingMeter RSS" href="/rss.xml" />
    <link rel="alternate" type="application/feed+json" title="RoofingMeter Blog" href="/feed.json" />

    <ClientRouter />
    <meta name="author" content={config.metadata.meta_author} />
    
    <!-- ROOFING GATE STYLES - PARTIAL GATE VERSION -->
    {hasGatedContent && (
      <style>
        /* Gate Overlay - PARTIAL POSITIONING */
        .roofing-gate-overlay {
          position: absolute !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          background: rgba(248, 250, 252, 0.95) !important; /* roofing light */
          backdrop-filter: blur(15px) !important;
          -webkit-backdrop-filter: blur(15px) !important;
          z-index: 2147483647 !important;
          display: none !important;
          justify-content: center !important;
          align-items: center !important;
          opacity: 0 !important;
          transition: opacity 0.4s ease !important;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
          pointer-events: auto !important;
        }
        
        .roofing-gate-overlay.active {
          opacity: 1 !important;
          display: flex !important;
        }
        
        /* Gate Modal */
        .roofing-gate-modal {
          background: white !important;
          border: 3px solid #1e3a8a !important; /* roofing primary blue */
          box-shadow: 15px 15px 0px rgba(30, 58, 138, 0.15) !important;
          padding: 3rem !important;
          max-width: 520px !important;
          width: 90% !important;
          text-align: center !important;
          border-radius: 12px !important;
          position: relative !important;
          animation: modalSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) !important;
          transform-origin: center !important;
          z-index: 2147483647 !important;
          pointer-events: auto !important;
        }
        
        @keyframes modalSlideUp {
          from {
            opacity: 0;
            transform: translateY(40px) scale(0.9);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
        
        /* Gate Header */
        .gate-header {
          margin-bottom: 1.5rem !important;
        }
        
        .gate-icon {
          font-size: 3.5rem !important;
          margin-bottom: 1rem !important;
          display: block !important;
          color: #1e3a8a !important; /* roofing blue */
          animation: float 3s ease-in-out infinite !important;
        }
        
        @keyframes float {
          0%, 100% { transform: translateY(0) rotate(0deg); }
          25% { transform: translateY(-8px) rotate(5deg); }
          75% { transform: translateY(-4px) rotate(-5deg); }
        }
        
        .gate-title {
          font-size: 2rem !important;
          font-weight: 900 !important;
          margin: 0 0 0.5rem 0 !important;
          color: #1e3a8a !important; /* roofing blue */
          letter-spacing: -0.5px !important;
          line-height: 1.2 !important;
        }
        
        .gate-subtitle {
          font-size: 1.15rem !important;
          color: #6b7280 !important; /* roofing gray */
          margin: 0 !important;
          line-height: 1.6 !important;
          font-weight: 400 !important;
        }
        
        /* Gate Form */
        .gate-form {
          margin: 2rem 0 !important;
        }
        
        .gate-input {
          width: 100% !important;
          padding: 1rem 1.25rem !important;
          font-size: 1.05rem !important;
          border: 2px solid #d1d5db !important;
          border-radius: 8px !important;
          margin-bottom: 1rem !important;
          box-sizing: border-box !important;
          transition: all 0.3s ease !important;
          font-family: inherit !important;
          background: white !important;
        }
        
        .gate-input:focus {
          outline: none !important;
          border-color: #1e3a8a !important; /* roofing blue */
          box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1) !important;
          transform: translateY(-2px) !important;
        }
        
        .gate-button {
          width: 100% !important;
          padding: 1.1rem 1.25rem !important;
          background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%) !important; /* roofing blue gradient */
          color: white !important;
          border: none !important;
          font-size: 1.1rem !important;
          font-weight: 800 !important;
          border-radius: 8px !important;
          cursor: pointer !important;
          transition: all 0.3s ease !important;
          font-family: inherit !important;
          letter-spacing: -0.2px !important;
          text-transform: uppercase !important;
          letter-spacing: 1px !important;
        }
        
        .gate-button:hover {
          background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%) !important;
          transform: translateY(-3px) !important;
          box-shadow: 0 15px 30px rgba(30, 58, 138, 0.2) !important;
        }
        
        .gate-button:active {
          transform: translateY(-1px) !important;
        }
        
        /* Gate Footer */
        .gate-footer {
          margin-top: 2rem !important;
          padding-top: 1.5rem !important;
          border-top: 2px solid #e5e7eb !important;
        }
        
        .gate-alternative {
          background: transparent !important;
          color: #1e3a8a !important; /* roofing blue */
          border: 2px solid #1e3a8a !important;
          padding: 0.85rem 1.75rem !important;
          font-weight: 700 !important;
          border-radius: 8px !important;
          cursor: pointer !important;
          transition: all 0.3s ease !important;
          font-size: 1rem !important;
          font-family: inherit !important;
          width: 100% !important;
          margin-bottom: 1rem !important;
        }
        
        .gate-alternative:hover {
          background: #1e3a8a !important;
          color: white !important;
          transform: translateY(-2px) !important;
        }
        
        .gate-legal {
          font-size: 0.85rem !important;
          color: #6b7280 !important;
          margin-top: 1rem !important;
          line-height: 1.5 !important;
        }
        
        .gate-legal a {
          color: #1e3a8a !important;
          text-decoration: underline !important;
          font-weight: 600 !important;
        }
        
        /* Content Blur Effect - FOR PARTIAL GATE */
        .gate-blur {
          filter: blur(8px) !important;
          pointer-events: none !important;
          user-select: none !important;
          opacity: 0.6 !important;
          transition: filter 0.5s ease, opacity 0.5s ease !important;
        }
        
        /* Keep first 40% clear */
        .gate-clear {
          filter: blur(0) !important;
          opacity: 1 !important;
          pointer-events: auto !important;
        }
        
        /* Close Button */
        .gate-close {
          position: absolute !important;
          top: 1.2rem !important;
          right: 1.2rem !important;
          background: #f3f4f6 !important;
          border: 2px solid #d1d5db !important;
          font-size: 1.8rem !important;
          cursor: pointer !important;
          color: #374151 !important;
          padding: 0.5rem !important;
          border-radius: 50% !important;
          transition: all 0.3s ease !important;
          width: 3rem !important;
          height: 3rem !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          line-height: 1 !important;
          z-index: 2147483647 !important;
        }
        
        .gate-close:hover {
          color: #1e3a8a !important; /* roofing blue */
          background: #e5e7eb !important;
          border-color: #1e3a8a !important;
          transform: rotate(90deg) !important;
        }
        
        /* Success State */
        .gate-success .gate-icon {
          color: #10b981 !important; /* roofing green */
          animation: none !important;
        }
        
        .gate-success .gate-button {
          background: #10b981 !important;
        }
        
        /* Force all elements to be visible */
        .roofing-gate-overlay * {
          visibility: visible !important;
          opacity: 1 !important;
        }
        
        /* Responsive */
        @media (max-width: 640px) {
          .roofing-gate-modal {
            padding: 2rem 1.5rem !important;
            width: 95% !important;
            margin: 1rem !important;
          }
          
          .gate-title {
            font-size: 1.7rem !important;
          }
          
          .gate-subtitle {
            font-size: 1.05rem !important;
          }
          
          .gate-icon {
            font-size: 2.8rem !important;
          }
        }
      </style>
    )}
    
    <!-- SIMPLE THEME SCRIPT -->
    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add('dark');
          document.documentElement.setAttribute('data-theme', 'dark');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#0f172a');
        } else {
          document.documentElement.classList.remove('dark');
          document.documentElement.setAttribute('data-theme', 'light');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#1e3a8a');
        }
        
        if (!savedTheme) {
          localStorage.setItem('theme', prefersDark ? 'dark' : 'light');
        }
      })();
    </script>
    
    <style>
      * {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      }
      
      /* Roofing-themed scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
      }
      
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #1e3a8a;
        border-radius: 5px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #2563eb;
      }
    </style>
  </head>

  <body class="bg-body text-text font-primary font-normal leading-relaxed dark:bg-dark dark:text-light">
    <TwSizeIndicator />
    <Header />
    <main id="main-content" class="min-h-[60vh]">
      <slot />
    </main>
    <Footer />

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <FloatingBubble client:load />
  
    <!-- ROOFING GATE IMPLEMENTATION - USING ROOFINGMETER BEEHIV -->
    {hasGatedContent && (
      <>
        <!-- Gate HTML Structure -->
        <div id="roofing-gate" class="roofing-gate-overlay">
          <div class="roofing-gate-modal">
            <button class="gate-close" aria-label="Close gate">√ó</button>
            
            <div class="gate-header">
              <span class="gate-icon">üè†</span>
              <h2 class="gate-title">Get Your Free Roofing Report</h2>
              <p class="gate-subtitle">Join the RoofingMeter newsletter for exclusive roofing guides, cost calculators, and contractor discounts.</p>
            </div>
            
            <div class="gate-form">
              <input type="email" class="gate-input" placeholder="your.email@example.com" id="gate-email-input" required>
              <button class="gate-button">
                Get Free Roofing Report
              </button>
            </div>
            
            <div class="gate-footer">
              <!-- RoofingMeter Beehiiv Embed -->
              <script async src="https://subscribe-forms.beehiiv.com/embed.js"></script>
              <iframe 
                src="https://subscribe-forms.beehiiv.com/967a3a10-7629-4938-af89-881c58918e73" 
                class="beehiiv-embed" 
                data-test-id="beehiiv-embed" 
                frameborder="0" 
                scrolling="no" 
                style="width: 100%; height: 150px; margin: 15px 0; border-radius: 8px; background-color: transparent; box-shadow: 0 0 #0000; max-width: 100%;">
              </iframe>
              
              <p class="gate-legal">
                By subscribing, you agree to our <a href="/privacy">Privacy Policy</a>.
                No spam. Unsubscribe anytime.
              </p>
              <p class="gate-legal" style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">
                A Txchyon Capital property
              </p>
            </div>
          </div>
        </div>
        
        <!-- Gate JavaScript - USING ROOFINGMETER BEEHIV -->
        <script>
          console.log('üè† ROOFINGMETER GATE SYSTEM: Loading...');
          
          // Configuration - PARTIAL GATE
          const ROOFING_GATE_CONFIG = {
            isPartialGate: true,
            scrollThreshold: 0.4, // 40% scroll
            showAfterSeconds: 60, // 60 seconds timeout
            forceShow: false // Set to true for testing
          };
          
          // RoofingMeter Beehiiv Configuration
          const ROOFINGMETER_BEEHIV = {
            embedId: '967a3a10-7629-4938-af89-881c58918e73',
            embedSrc: 'https://subscribe-forms.beehiiv.com/967a3a10-7629-4938-af89-881c58918e73'
          };
          
          console.log(`üìã RoofingMeter Gate: ${ROOFING_GATE_CONFIG.isPartialGate ? 'Partial (40% visible)' : 'Full'}`);
          console.log(`üìß RoofingMeter Beehiiv: ${ROOFINGMETER_BEEHIV.embedId}`);
          
          // Main function
          function initRoofingGate() {
            console.log('‚ö° Initializing ROOFINGMETER gate...');
            
            // Check if already subscribed to RoofingMeter
            const hasRoofingAccess = localStorage.getItem('roofingmeter_subscriber') === 'true';
            if (hasRoofingAccess && !ROOFING_GATE_CONFIG.forceShow) {
              console.log('‚úÖ Already subscribed to RoofingMeter');
              return;
            }
            
            // Setup button listeners
            setupRoofingButtons();
            
            // FORCE SHOW FOR TESTING - REMOVE LATER
            if (ROOFING_GATE_CONFIG.forceShow) {
              console.log('üß™ FORCE SHOWING ROOFINGMETER GATE FOR TESTING');
              setTimeout(() => {
                showRoofingGateWithBlur();
              }, 1000);
            }
            
            if (ROOFING_GATE_CONFIG.isPartialGate) {
              console.log('‚è∏Ô∏è RoofingMeter partial gate: monitoring scroll (40% threshold)...');
              setupRoofingPartialGate();
            } else {
              console.log('üö´ RoofingMeter full gate: showing immediately');
              showRoofingGateWithBlur();
            }
          }
          
          // Setup button event listeners
          function setupRoofingButtons() {
            console.log('üîß Setting up RoofingMeter buttons...');
            
            // Unlock button
            const unlockBtn = document.querySelector('.gate-button');
            if (unlockBtn) {
              unlockBtn.addEventListener('click', function(e) {
                e.preventDefault();
                // Let Beehiiv iframe handle the subscription
                const beehiivIframe = document.querySelector('.beehiiv-embed');
                if (beehiivIframe) {
                  beehiivIframe.scrollIntoView({ behavior: 'smooth' });
                  console.log('üìß Scroll to Beehiiv form');
                }
              });
            }
            
            // Close button
            const closeBtn = document.querySelector('.gate-close');
            if (closeBtn) {
              closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeRoofingGate();
              });
            }
            
            // Email input enter key - focus Beehiiv
            const emailInput = document.getElementById('gate-email-input');
            if (emailInput) {
              emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  const beehiivIframe = document.querySelector('.beehiiv-embed');
                  if (beehiivIframe) {
                    beehiivIframe.scrollIntoView({ behavior: 'smooth' });
                  }
                }
              });
            }
            
            // Listen for Beehiiv subscription success
            window.addEventListener('message', function(event) {
              if (event.origin === 'https://subscribe-forms.beehiiv.com') {
                console.log('üì© Beehiiv message received:', event.data);
                if (event.data && event.data.type === 'subscription_success') {
                  handleBeehiivSuccess(event.data.email);
                }
              }
            });
          }
          
          // Handle successful Beehiiv subscription
          function handleBeehiivSuccess(email) {
            console.log('üéâ Beehiiv subscription success for:', email);
            grantRoofingAccess(email);
            alert('‚úÖ Thank you for subscribing to RoofingMeter! Your free roofing report is on its way.');
          }
          
          // Setup roofing partial gate (scroll detection)
          function setupRoofingPartialGate() {
            let gateShown = false;
            
            function checkScroll() {
              if (gateShown) return;
              
              const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
              console.log(`üìä RoofingMeter Scroll: ${scrollPercent.toFixed(1)}%`);
              
              if (scrollPercent >= (ROOFING_GATE_CONFIG.scrollThreshold * 100)) {
                gateShown = true;
                console.log('üéØ Reached 40%, showing ROOFINGMETER gate!');
                showRoofingGateWithBlur();
                window.removeEventListener('scroll', checkScroll);
              }
            }
            
            window.addEventListener('scroll', checkScroll);
            
            // Also show after timeout
            setTimeout(() => {
              if (!gateShown) {
                gateShown = true;
                console.log('‚è∞ 60 seconds passed, showing RoofingMeter gate!');
                showRoofingGateWithBlur();
              }
            }, ROOFING_GATE_CONFIG.showAfterSeconds * 1000);
          }
          
          // Show ROOFING partial gate with blur effect
          function showRoofingGateWithBlur() {
            console.log('üöÄ Showing ROOFINGMETER partial gate with blur...');
            
            const gate = document.getElementById('roofing-gate');
            console.log('üîç RoofingMeter gate element exists:', !!gate);
            
            if (!gate) {
              console.error('‚ùå CRITICAL: RoofingMeter gate element not found in DOM!');
              return;
            }
            
            // Calculate where to place the gate (at 40% scroll position)
            const viewportHeight = window.innerHeight;
            const contentHeight = document.body.scrollHeight;
            const fortyPercentHeight = contentHeight * 0.4;
            
            console.log('üìè RoofingMeter gate positioning:', {
              viewportHeight,
              contentHeight,
              fortyPercentHeight: Math.round(fortyPercentHeight)
            });
            
            // Blur only the bottom 60% of content
            const mainContent = document.querySelector('main');
            if (!mainContent) {
              console.error('‚ùå No main content found');
              return;
            }
            
            // Find all content sections and blur only those below 40%
            const allElements = mainContent.querySelectorAll('*');
            let blurredElements = 0;
            let clearElements = 0;
            
            allElements.forEach(element => {
              const rect = element.getBoundingClientRect();
              const elementTop = rect.top + window.scrollY;
              
              // If element is BELOW 40% mark, blur it
              if (elementTop > fortyPercentHeight) {
                element.classList.add('gate-blur');
                element.classList.remove('gate-clear');
                blurredElements++;
              } else {
                // Element is in top 40%, keep it clear
                element.classList.remove('gate-blur');
                element.classList.add('gate-clear');
                clearElements++;
              }
            });
            
            console.log(`üå´Ô∏è RoofingMeter blur applied: ${blurredElements} elements blurred (bottom 60%), ${clearElements} elements clear (top 40%)`);
            
            // Position and show the gate at 40% scroll point
            const gateTopPosition = Math.max(fortyPercentHeight - (viewportHeight / 2), 100);
            
            // Apply inline styles for roofing gate
            gate.style.cssText = `
              display: flex !important;
              opacity: 1 !important;
              visibility: visible !important;
              position: absolute !important;
              top: ${gateTopPosition}px !important;
              left: 0 !important;
              width: 100vw !important;
              height: 100vh !important;
              background: rgba(248, 250, 252, 0.95) !important;
              backdrop-filter: blur(15px) !important;
              -webkit-backdrop-filter: blur(15px) !important;
              z-index: 2147483647 !important;
              align-items: center !important;
              justify-content: center !important;
              pointer-events: auto !important;
              transition: opacity 0.4s ease !important;
            `;
            
            // Add active class for animations
            setTimeout(() => {
              gate.classList.add('active');
              console.log('‚úÖ RoofingMeter gate overlay shown at 40% position');
              
              // Focus email input
              const emailInput = document.getElementById('gate-email-input');
              if (emailInput) {
                setTimeout(() => {
                  emailInput.focus();
                  console.log('üìß RoofingMeter email input focused');
                }, 100);
              }
              
              // Scroll to show the gate smoothly
              window.scrollTo({
                top: gateTopPosition - 100,
                behavior: 'smooth'
              });
              
              console.log('üìç RoofingMeter gate positioned at:', gateTopPosition, 'px');
              
            }, 10);
          }
          
          // Grant roofing access
          function grantRoofingAccess(email) {
            console.log('üîì Granting RoofingMeter access for:', email);
            
            // Mark as subscribed to RoofingMeter
            localStorage.setItem('roofingmeter_subscriber', 'true');
            localStorage.setItem('roofingmeter_subscriber_email', email);
            
            // Hide gate
            const gate = document.getElementById('roofing-gate');
            if (gate) {
              gate.style.opacity = '0';
              setTimeout(() => gate.style.display = 'none', 400);
            }
            
            // Remove blur
            document.querySelectorAll('.gate-blur').forEach(el => {
              el.classList.remove('gate-blur');
            });
            
            // Remove clear classes
            document.querySelectorAll('.gate-clear').forEach(el => {
              el.classList.remove('gate-clear');
            });
            
            // Show success state
            const gateIcon = document.querySelector('.gate-icon');
            const gateButton = document.querySelector('.gate-button');
            if (gateIcon && gateButton) {
              gateIcon.textContent = '‚úÖ';
              gateButton.textContent = 'Subscribed!';
              gateButton.disabled = true;
              setTimeout(() => {
                gateIcon.textContent = 'üè†';
                gateButton.textContent = 'Get Free Roofing Report';
                gateButton.disabled = false;
              }, 5000);
            }
          }
          
          // Close roofing gate
          function closeRoofingGate() {
            console.log('üö™ Closing RoofingMeter gate...');
            const gate = document.getElementById('roofing-gate');
            if (gate) {
              gate.style.opacity = '0';
              setTimeout(() => gate.style.display = 'none', 400);
            }
          }
          
          // Reset function for testing
          window.resetRoofingGate = function() {
            console.log('üîÑ Resetting RoofingMeter gate...');
            localStorage.removeItem('roofingmeter_subscriber');
            localStorage.removeItem('roofingmeter_subscriber_email');
            location.reload();
          };
          
          // Manual test function
          window.testRoofingGate = function() {
            console.log('üß™ Manual RoofingMeter gate test');
            showRoofingGateWithBlur();
          };
          
          // Start
          document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded, starting RoofingMeter gate system...');
            setTimeout(initRoofingGate, 500);
          });
        </script>
      </>
    )}
  
    <!-- Theme toggle -->
    <script>
      function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');
        const newTheme = isDark ? 'light' : 'dark';
        
        if (newTheme === 'dark') {
          html.classList.add('dark');
          html.setAttribute('data-theme', 'dark');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#0f172a');
        } else {
          html.classList.remove('dark');
          html.setAttribute('data-theme', 'light');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#1e3a8a');
        }
        
        localStorage.setItem('theme', newTheme);
        updateThemeIcons();
      }
      
      function updateThemeIcons() {
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const isDark = document.documentElement.classList.contains('dark');
        
        if (sunIcon) sunIcon.classList.toggle('hidden', isDark);
        if (moonIcon) moonIcon.classList.toggle('hidden', !isDark);
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleDarkMode);
        }
        updateThemeIcons();
      });
      
      document.addEventListener('astro:page-load', () => {
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleDarkMode);
        }
        updateThemeIcons();
      });
    </script>
  </body>
</html>