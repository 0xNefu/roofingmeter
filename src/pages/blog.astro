---
// src/pages/blog.astro - Blog listing page
import { getCollection } from 'astro:content';
import Base from "@/layouts/Base.astro";
import Posts from "@/layouts/components/Posts.astro";
import Pagination from "@/layouts/components/Pagination.astro";

// Helper for readTime calculation (same as index.astro)
function calculateReadTime(content, wordsPerMinute = 130) {
  if (!content) return 10;
  const plainText = content
    .replace(/---[\s\S]*?---/, '')
    .replace(/```[\s\S]*?```/g, '')
    .replace(/<[^>]*>/g, '')
    .replace(/#{1,6}\s*/g, '')
    .replace(/[\[\]\(\)]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  const wordCount = plainText.split(/\s+/).length;
  const minutes = Math.ceil(wordCount / wordsPerMinute);
  return Math.max(1, Math.min(minutes, 60));
}

function getPostReadTime(post) {
  if (post.data.readTime) return post.data.readTime;
  if (post.body) return calculateReadTime(post.body);
  const estimates = {
    'getting-started': 8, 'security-privacy': 10,
    'airdrop-farming': 12, 'defi-yield': 15
  };
  return estimates[post.data.pillar] || 10;
}

// Get all posts with readTime
const allPostsRaw = await getCollection('posts', ({ data }) => !data.draft);
const allPosts = allPostsRaw.map(post => ({
  ...post,
  data: {
    ...post.data,
    readTime: getPostReadTime(post)
  }
}));

// Sort by date
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Pagination
const pageSize = 12;
const currentPage = 1; // You can add pagination logic later
const paginatedPosts = sortedPosts.slice(0, pageSize);
const totalPages = Math.ceil(allPosts.length / pageSize);
---

<Base 
  title="All Free DeFi Guides | Txchyon" 
  description="Browse all our premium-quality DeFi guides. 100% free. No gatekeeping, just actionable knowledge."
>
  <section class="min-h-screen bg-gradient-to-b from-black to-gray-900 py-20">
    <div class="container mx-auto px-4">
      {/* Hero Header */}
      <div class="text-center mb-16">
        <div class="inline-flex items-center gap-2 bg-black/40 backdrop-blur-sm border border-cyan-500/30 rounded-full px-6 py-3 mb-8">
          <span class="text-cyan-400">ğŸ“š</span>
          <span class="text-cyan-300 font-medium">
            ALL GUIDES â€¢ 100% FREE â€¢ NO SIGNUP REQUIRED
          </span>
        </div>
        
        <h1 class="text-4xl md:text-6xl font-bold text-white mb-6">
          Every Guide We've Published
        </h1>
        
        <p class="text-xl text-gray-400 max-w-3xl mx-auto">
          No paywalls. No "premium content" hidden away. Everything we create is free, forever.
        </p>
        
        {/* Stats */}
        <div class="flex flex-wrap justify-center gap-8 mt-10">
          <div class="text-center">
            <div class="text-3xl font-bold text-white">{allPosts.length}</div>
            <div class="text-gray-400">Total Guides</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-white">1,200+</div>
            <div class="text-gray-400">Active Readers</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-400">$0</div>
            <div class="text-gray-400">Everything Costs</div>
          </div>
        </div>
      </div>

      {/* Category Filter (Optional - can add later) */}
      <div class="flex flex-wrap gap-4 mb-12 justify-center">
        <a href="/categories/getting-started" 
           class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-blue-500/30 transition-all">
          ğŸš€ Getting Started
        </a>
        <a href="/categories/security-privacy" 
           class="px-5 py-2.5 bg-gradient-to-r from-red-500 to-pink-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-red-500/30 transition-all">
          ğŸ” Security & Privacy
        </a>
        <a href="/categories/airdrop-farming" 
           class="px-5 py-2.5 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-yellow-500/30 transition-all">
          ğŸª‚ Airdrop Farming
        </a>
        <a href="/categories/defi-yield" 
           class="px-5 py-2.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-green-500/30 transition-all">
          ğŸ’° DeFi Yield
        </a>
      </div>

      {/* Posts Grid */}
      <div class="mb-16">
        <Posts posts={paginatedPosts} className="grid-cols-1 md:grid-cols-2 lg:grid-cols-3" />
      </div>

      {/* Pagination */}
      {totalPages > 1 && (
        <div class="text-center mb-16">
          <Pagination currentPage={currentPage} totalPages={totalPages} />
        </div>
      )}

      {/* CTA */}
      <div class="bg-gradient-to-r from-gray-900/50 to-black/50 backdrop-blur-sm rounded-3xl border border-cyan-500/30 p-8 max-w-2xl mx-auto text-center">
        <h2 class="text-2xl font-bold text-white mb-4">Missing Something?</h2>
        <p class="text-gray-400 mb-6">
          Have a DeFi topic you want us to cover? We're building this in public and take community requests.
        </p>
        <a href="https://twitter.com/txchyon" target="_blank" 
           class="inline-flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold rounded-xl hover:shadow-xl hover:shadow-cyan-500/30 transition-all">
          <span>ğŸ¦</span>
          Suggest a Guide on Twitter
        </a>
      </div>
    </div>
  </section>
</Base>